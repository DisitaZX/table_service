{% extends 'base.html' %}
{% load django_tables2 %}
{% load static %}

{% block content %}
<head>
    <link href="{% static 'css/bootstrap-icons.css' %}" rel="stylesheet">
    <link href="{% static 'css/column_tables.css' %}" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/table_form.css' %}">
</head>
<h1>{{ table_obj.title }}</h1>
<p>Владелец таблицы: {{ table_obj.owner }}</p>

<div class="d-flex justify-content-between">
{% if table_obj.owner == request.user or is_admin %}
    <div id="clickable-btns">
        <a href="{% url 'add_column' table_obj.pk %}" class="btn btn-primary">
            <i class="fas fa-columns me-1"></i> Добавить столбец
        </a>
        <a class="btn btn-success add-row-btn" data-table-id="{{ table_obj.pk }}">
            <i class="fa-solid fa-plus"></i> Добавить строку
        </a>
        <a href="{{ table_obj.get_shared_url }}" class="btn btn-outline-dark">
           <i class="fa-solid fa-share-nodes me-1"></i> Поделиться таблицей
        </a>
        <a href="{% url 'manage_table_permissions' table_obj.pk %}" class="btn btn-outline-warning">
            <i class="fa-solid fa-pen-to-square"></i> Редактировать права на таблицу
        </a>
        <a href="{% url 'export_table' table_obj.pk %}" class="btn btn-outline-primary">
            <i class="bi bi-box-arrow-in-down"></i> Экспорт таблицы
        </a>
        <a href="{% url 'import_new_rows' table_obj.pk %}" class="btn btn-outline-primary">
            <i class="bi bi-file-earmark-plus-fill"></i> Добавить новые строки из файла
        </a>
    </div>
    <div id="clickable-btns">
        <a href="{% url 'delete_table' table_obj.pk %}" class="btn btn-danger"
           onclick="return confirm('Удалить таблицу?')">
            <i class="fas fa-ban"></i> Удалить таблицу
        </a>
        {% if filials %}
            <div class="dropdown">
                <!-- Основная кнопка -->
                <a href="#" class="btn btn-danger dropdown-toggle"
                   id="revokeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ban"></i> Завершение редактирования
                </a>

                <!-- Выпадающее меню -->
                <ul class="dropdown-menu" aria-labelledby="revokeDropdown">
                    <li>
                        <a class="dropdown-item"
                           href="{% url 'revoke_redact_rows' share_token=table_obj.share_token id_filial=0%}"
                           onclick="return confirm('Снять права у всех пользователей и филиалов?')">
                            Все
                        </a>
                        {% for perm in filials %}
                            <a class="dropdown-item"
                               href="{% url 'revoke_redact_rows' share_token=table_obj.share_token id_filial=perm.id%}"
                               onclick="return confirm('Снять права у всех пользователей филиала {{ perm.name }}?')">
                                {{ perm }}
                            </a>
                        {% endfor %}
                    </li>
                </ul>
            </div>
        {% endif %}
    </div>
{% endif %}
</div>

<div class="table-responsive">
    <form method="get" class="mb-3">
        <div class="input-group">
            <input type="text" name="q" class="form-control" placeholder="Поиск..."
                   value="{{ request.GET.q }}">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> Поиск
            </button>
            {% if request.GET.q %}
            <a href="?" class="btn btn-outline-secondary">Сбросить</a>
            {% endif %}
        </div>
    </form>
    <a href="{{ table.get_reset_filters_url }}" class="btn btn-sm btn-outline-secondary mb-3">
        <i class="bi bi-funnel"> Сбросить все фильтры</i>
    </a>
    {% if mass_permissions %}
    {% with filter_params=request.GET.urlencode %}
        {% if "filter" in filter_params %}
            <div class="dropdown">
                <!-- Основная кнопка -->
                <a href="#" class="btn btn-sm btn-outline-secondary mb-3 dropdown-toggle"
                   id="MassEditDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-pencil-square"> Редактировать выбранные фильтром</i>
                </a>

                <!-- Выпадающее меню -->
                <ul class="dropdown-menu" aria-labelledby="MassEditDropdown">
                    <!-- Передаём ID всех видимых строк -->
                    {% for row in table.rows %}
                        <input type="hidden" name="row_ids[]" value="{{ row.record.id }}">
                    {% endfor %}
                    <li>
                        <a class="dropdown-item mass-edit-row-btn"
                           data-table-id="{{ table_obj.pk }}">
                            <i class="bi bi-exposure" style="color: green;"></i> Редактировать выбранные строки
                        </a>
                        <a class="dropdown-item mass-delete-row-btn"
                           data-table-id="{{ table_obj.pk }}">
                            <i class="bi bi-x-circle" style="color: red;"></i> Удалить выбранные строки
                        </a>
                    </li>
                </ul>
            </div>
        {% endif %}
    {% endwith %}
    {% endif %}
    {% render_table table %}
</div>
<!-- Модальное окно добавления строки -->
<div class="modal fade" id="addRowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавление новой строки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div id="addRowModalContent">
                <!-- Форма будет загружена через AJAX -->
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="rowEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактирование строки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div id="modalContent">
                <!-- Форма будет загружена через AJAX -->
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="rowMassEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Массовое редактирование строк</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div id="modalMassContent">
                <!-- Форма будет загружена через AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
    <script src="{% static 'js/row_edit_modal.js' %}"></script>
    <script>
    // Обработка форм фильтрации без перезагрузки страницы
    document.querySelectorAll('.filter-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const params = new URLSearchParams(formData);

            // Сохраняем существующие параметры
            const currentParams = new URLSearchParams(window.location.search);
            currentParams.forEach((value, key) => {
                if (!params.has(key)) {
                    params.append(key, value);
                }
            });

            window.location.search = params.toString();
        });
    });
    </script>
{% endblock %}